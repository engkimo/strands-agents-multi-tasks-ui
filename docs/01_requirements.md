# 目的
本プロジェクトでは、LLM 向けエージェントフレームワーク **Strands Agents** を採用し、外部の CLI ツール（Claude Code、Codex CLI、Gemini CLI、Spec Kit など）を Python ラッパーとして登録して利用する。Graph／Swarm パターンにより各ツールをノードとして並列実行し、実行状況・入力・出力を確認できるモダンな UI を構築する。

## 背景

- Strands Agents は Python SDK ベースのエージェントフレームワークであり、通常の Python 関数やモジュールに `@tool` デコレータを付けるだけでツールとして登録できる[^1]。
- 非同期関数で実装したツールは `invoke_async` で並列実行できるため、複数の CLI を同時に呼び出すことが可能[^2]。
- Graph パターンでは DAG を構築し、条件分岐を設定して実行結果に応じて次のノードを選択できる[^3]。Swarm パターンでは複数エージェントが共有コンテキストの下で協調し、非同期にタスクを処理できる[^4]。
- Strands Agents は OpenTelemetry 準拠のトレーシング・メトリクスを提供するが専用 UI はない。ダッシュボードに送ることで可視化できる[^5]。

## システム概要

1. **ツール登録**: 各 CLI（Claude Code、Codex CLI、Gemini CLI、Spec Kit）を Python 関数としてラップし、`@tool` デコレータを付けて Strands Agents に登録する。ドックストリングと型注釈を記述し、CLI の引数をツールの入力として定義する[^6]。
2. **非同期実装**: CLI 呼び出しは I/O 待ちが長い可能性があるため、`async def` 関数で `asyncio.create_subprocess_shell` 等を使用して実装し、非同期実行を可能とする[^2]。
3. **Graph パターン**: CLI のラッパーツールをノードとした DAG を構築し、条件関数により出力に応じた分岐を行う。結果の集合・解析や次の処理の決定を自動化する[^3]。
4. **Swarm パターン**: 複数エージェントをスワームとして構成し、それぞれ別の CLI ツールを担当させる。共有コンテキストにより結果を共有しながら協調的に処理を行う[^4]。
5. **モニタリング UI**: Dagster の Dagit UI のように、フロー実行中の各タスクの状態、入力・出力、ログを確認できる独自 UI を実装する。Strands Agents の OpenTelemetry テレメトリ情報とツールの実行結果を利用し、ステータス遷移・実行時間・エラーを視覚的に表示する。ツール呼び出し単位のログ、CLI の標準出力／標準エラー、トークン使用量も確認できるようにする。

## 機能要件

### ツール管理

1. **ツール定義**
   - Python ラッパーとして CLI を実行する関数を定義し、`@tool` デコレータで装飾する[^6]。
   - ドックストリングにはツールの概要と引数説明を記述し、型注釈を付ける。
   - 戻り値は `ToolResult` 形式の辞書または文字列にし、成功・エラー時のレスポンスを明示する[^7]。
2. **ツール読み込み**
   - ツールはエージェント初期化時に `tools=[...]` で登録する[^8]。
   - 将来的にツールの追加・更新を容易にするため、モジュール方式 (`TOOL_SPEC` と実装関数) での読み込みにも対応する[^9]。

### ワークフロー構築

3. **Graph フロー**
   - 登録したツールを Graph パターンのノードとして配置する。
   - 各ノード間に条件関数やエッジを設定し、結果に基づいた分岐やループを記述する。
   - `invoke_async` を使用して非同期にノードを実行し、結果を待ち合わせて次の処理を行う[^2]。
4. **Swarm フロー**
   - Swarm 構成では複数のエージェントが協調してタスクを実行する。各エージェントには特定の CLI ツールがバインドされ、共有コンテキストを介してデータをやり取りする[^4]。
   - Swarm の実行中は各エージェントが並行してタスクを処理し、完了した結果を集約するフェーズを設ける。

### UI／モニタリング

5. **実行状況の可視化**
   - 各ツール（ノード）の実行開始・終了、現在の状態（待機中／実行中／成功／失敗）をリアルタイムに表示する。
   - 入力パラメータ、返却された `ToolResult` の内容、CLI の標準出力／エラー、ツールのトークン使用量や実行時間を表示する[^5]。
6. **ダッシュボード機能**
   - DAG／Swarm グラフを視覚化し、依存関係や並列実行ノードを確認できるようにする。
   - フィルタリングや検索により、特定のノードやエージェントの履歴を追跡できるようにする。
   - メトリクスの集計（実行回数、成功率、平均レイテンシ）やエラー発生率をグラフ表示する。

### エラー処理・リトライ

7. **エラー分類**
   - CLI 実行時のエラー（非ゼロ終了コード、タイムアウト）、通信エラー、入力バリデーションエラーを分類し、UI 上で識別できるようにする。
8. **リトライポリシー**
   - Graph／Swarm ノードごとに再試行回数や待ち時間を設定し、失敗時に自動でリトライする機能を実装する。

### 拡張性・運用

9. **新規ツール追加**
   - 新しい CLI ツールを追加する際は Python ラッパーを作成し、エージェント設定に追加するだけで済むように設計する。
10. **ログとトレース**
   - 全てのツール実行に対してトレース ID を付与し、OpenTelemetry 準拠のトレースおよびメトリクスを収集する[^5]。
   - 将来的に外部のログ分析基盤（e.g. Grafana, Langfuse）へデータを送信して高度な分析を行えるようにする。
11. **セキュリティ**
   - CLI を実行するコンテナの権限を最小限にする。
   - 入力値のサニタイズを徹底し、インジェクション攻撃を防止する。

## 非機能要件

- **性能**: CLI ツールの平均応答時間に加えて、非同期実行で 10 件以上の並列呼び出しに対応できること。
- **可用性**: システムダウン時も各ツールの状態が失われないように状態管理を行い、リスタート後に再実行・再開できること。
- **拡張性**: ツールやエージェントの追加に対してコード変更が最小限で済み、将来的な機能追加や新しいモデル統合が容易であること。
- **使いやすさ**: UI は直感的であり、エンジニアでない利用者でも実行状況や入出力を確認できること。

## 参考文献
- Strands Agents の公式ドキュメントでは `@tool` デコレータによって関数を簡単にツール化し、`async` 対応で並列実行できることが紹介されている[^1][^2]。
- Graph パターンではノードの結果に応じて分岐を定義でき、Swarm パターンでは複数エージェントが非同期に協調する[^3][^4]。
- OpenTelemetry ベースのトレース・メトリクスを活用して実行状況をモニタリングすることができる[^5]。

